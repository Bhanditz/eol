!!!
%html{ "xml:lang" => "en", :lang => "en", :xmlns => "http://www.w3.org/1999/xhtml" }
  %head
    %meta{ :name => "verify-v1", :content => "mJIytYT6a+K1y+bCmD1wr1ge+4Q63O0YfTHCYWwkzaY=" }
    %meta{ :content => "text/html; charset=utf-8", "http-equiv" => "Content-type" }
    %meta{ :content => "en-us", "http-equiv" => "Content-Language" }
    %title
      - page_title = "Encyclopedia of Life"[:encyclopedia_of_life] 
      - page_title = "#{@taxon_concept.title(@session_hierarchy)} - #{page_title}" if (@taxon_concept and not @taxon_concept.title(@session_hierarchy).blank?) 
      - page_title = @page_title if @page_title 
      &= strip_tags(page_title)
    %meta{ :content => "no", "http-equiv" => "imagetoolbar" }
    %meta{ :name => "MSSmartTagsPreventParsing", :content => "true" }
    %meta{ :content => "IE=EmulateIE7", "http-equiv" => "X-UA-Compatible" }

    - if @taxon_concept
      %meta{ :name => "description", :content => h(strip_tags("#{@taxon_concept.title} (#{@taxon_concept.subtitle}) in Encyclopedia of Life")) }
      %meta{ :name => "keywords", :content => meta_keywords(h(strip_tags(@taxon_concept.title + ' ' + @taxon_concept.subtitle))) }
    
      - if @taxon_concept.has_feed?
        %link#content_rss{ :title => 'Latest Content', :href => url_for(:controller => :feeds, :action => :all, :id => @taxon_concept.id), :rel => "alternate", :type => "application/rss+xml"}
      - if (@taxon_concept.entry && @taxon_concept.entry.hierarchies_content && (@taxon_concept.entry.hierarchies_content.image != 0 || @taxon_concept.entry.hierarchies_content.child_image != 0))
        %link#media_rss{ :title => 'MediaRSS Feed', :href => "/content/mediarss?format=rss&id=#{@taxon_concept.id}", :rel => "alternate", :type => "application/rss+xml" }
      - else
        %meta{ :name => "description", :content => "Encyclopedia of Life" }
        %meta{ :name => "keywords", :content => "Encyclopedia of Life,Biodiversity,Biology,Bioinformatics" }
    
    - if @no_cache
      %meta{ :content => "NO-CACHE", "http-equiv" => "CACHE-CONTROL" }
      %meta{ :content => "NO-CACHE", "http-equiv" => "PRAGMA" }

    %link{ :href => "/favicon.ico", :rel => "shortcut icon", :type => "image/x-icon" }
    %link{ :href => "/opensearchdescription.xml", :title => "Encyclopedia of Life", :rel => "search", :type => "application/opensearchdescription+xml" }
    = stylesheet_link_merged 'base-cached'
    = eol_lang_main_stylesheet 'buttons', :media => "all"
    = stylesheet_link_tag 'star_rating'
    = stylesheet_link_tag 'wikipedia'
    = javascript_include_merged 'base-cached'
    /[if lt IE 7]
      %style{:type => "text/css", :media => "screen"}
        body { behavior: url(/javascripts/csshover.htc); }
    = yield :head

  %body{ :id => "#{h controller.controller_name}-page" }
    %ul.hide
      %li
        %a{ :href => "#global-navigation", :title => "Skip to navigation"[] }
          = "Skip to navigation"[]
      %li
        %a{ :href => "#toc", :title => "Skip to table of contents"[] }
          = "Skip to table of contents"[]
      %li
        %a{ :href => "#center-page-content", :title => "Skip to content"[] }
          = "Skip to content"[]
    %hr
    #container
      #header
        %h1
          %a{ :href => root_url, :title => "Encyclopedia of Life"[:encyclopedia_of_life] }
            %span
        %hr
        - cache(:controller => '/content', :part => 'top_nav_' + current_user.language_abbr) do
          %p.hide
            = "Global Navigation"[]
          %ul#global-navigation
            %li
              %a{ :href => root_url, :title => "Home"[] }
                = "Home"[]
            %li
              = link_to('Preferences'[], settings_url, {:title => 'Preferences'[], :class => 'return_to'})
            %li
              %a.dropdown{ :title => "#{"Language"[]}: #{Gibberish.current_language}" }
                = "Language"[]
                \:
                = Gibberish.current_language
              %ul.uppercase
                - Language.find_active.each do |language|
                  %li
                    = link_to("#{language.name} <em>(#{language.display_code})</em>", set_language_url(:language => language.iso_639_1), :class => 'return_to', :title => language.name)
                %li
                  = link_to 'Google Translate', {:controller => '/content', :action => 'translate'}, {:class => 'return_to', :title => 'Google Translate'}
            %li
              %a#feedback.dropdown{ :title => "Feedback"[] }
                = "Feedback"[]
              %ul.uppercase
                = render :partial => 'layouts/top_menu', :locals => {:menu_items => ContentSection.find_pages_by_section('Feedback')}
            %li
              %a#press_room.dropdown{ :title => "Press Room"[] }
                = "Press Room"[]
              %ul.uppercase
                = render :partial => 'layouts/top_menu', :locals => {:menu_items => ContentSection.find_pages_by_section('Press Room')}
            %li
              %a#using_the_site.dropdown{ :title => "Using The Site"[] }
                = "Using The Site"[]
              %ul.uppercase
                = render :partial => 'layouts/top_menu', :locals => {:menu_items => ContentSection.find_pages_by_section('Using the Site')}
            %li.last
              %a#about_eol.last.dropdown{ :title => "About EOL"[] }
                = "About EOL"[]
              %ul.uppercase
                = render :partial => 'layouts/top_menu', :locals => {:menu_items => ContentSection.find_pages_by_section('About EOL')}
          %hr
          
        #ajax-indicator.ajax-indicator{ :style => "display:none;" }
          = image_tag('indicator_arrows_black.gif', :alt => 'loading', :title => 'loading')
        %p.hide
          = "Personal Space"[]
        #personal-space
          - if @home_page
            %span.quote
              "Imagine an electronic page for each species of organism on Earth..."
            \- Edward O. Wilson
          - if logged_in? && $ALLOW_USER_LOGINS && !agent_logged_in?
            .desc-personal
              %p
                %strong
                  - if current_user.is_curator?
                    = link_to("Hello {user}"[:hello_user, current_user.given_name], {:controller => '/account', :action => 'show', :id => current_user.id}, {:class => 'return_to'})
                  - else
                    = "Hello {user}"[:hello_user, current_user.given_name]

                = @home_page.nil? ? "</p><p>" : " | "
                = link_to("admin"[],{:controller => '/admin',:action => 'index'}) + " | " if current_user.is_admin?
                - if current_user.is_curator?
                  = link_to("curators", {:controller => '/content', :action => 'page', :id => 'curator_central'})
                  |
                = link_to("your preferences"[:your_preferences], {:controller => '/account', :action => 'profile'}, {:class => 'return_to'})
                |
                = link_to("logout"[:logout], logout_url, {:class => 'return_to'})
          - elsif $ALLOW_USER_LOGINS && !agent_logged_in?
            %p
              = link_to("login"[:login], {:controller => '/account', :action => 'login'}, {:class => 'return_to'})
              |
              = link_to("create an account"[:create_account], {:controller => '/account', :action => 'signup'}, {:class => 'return_to'})
          - elsif $ALLOW_USER_LOGINS == false && @home_page.nil?
            %p
              = "We apologize, but the user registration system is not currently available.  Please try again later."[:user_system_down]
          - elsif agent_logged_in?
            .desc-personal
              %p
                %strong
                  = "Hello {user}"[:hello_user, current_agent.full_name]
                = @home_page.nil? ? "</p><p>" : " | "
                = link_to("dashboard"[],:controller => '/content_partner',:action => 'index')
                |
                = link_to("logout"[:logout], {:controller => '/content_partner',:action => 'logout'},  {:class => 'return_to'})
          %hr
        #quick-search
          = render :partial => "/layouts/search_field"
        
        - if @taxon_concept
          .page-mode

            - if current_user.vetted
              - current_mode="authoritative information"[];change_mode="all information"[];set_vetted="false"
            - else  
              - current_mode="all information"[];change_mode="authoritative information"[];set_vetted="true"

            Showing:
            %a{ :href => "#{current_url}?vetted=#{set_vetted}", :title => "click to show #{change_mode}" }
              = current_mode
            %br
            - if (current_user.default_hierarchy_id.to_s != Hierarchy.default.id.to_s && !current_user.default_hierarchy_id.blank?)
              %a{ :href => url_for(settings_url), :title => "using #{current_user.selected_default_hierarchy}, click to change" }
                = "Alternate classification"[]
              %br
            - if current_user.filter_content_by_hierarchy
              %a{ :href => url_for(settings_url), :title => "click to change settings" }
                = "Filtered information"[]
              %br
      - # a div to wrap *just* the rendered template, so it's easy to update the whole template via Ajax calls, if needed
      #content
        = yield(:content) or yield
      #footer
        = render :partial => 'layouts/footer_menu', :locals => {:menu_items => ContentSection.find_pages_by_section('Footer')}
        = ENV['APP_VERSION'] unless ENV['APP_VERSION'].blank?
        - if flash[:warning] || flash[:error]
          = link_to('Show warning message'[], '#', :id => 'show-flash', :rel => '#flash-bad')
        - elsif flash[:notice]
          = link_to('Show status message'[], '#', :id => 'show-flash', :rel => '#flash-good')
    - if flash[:notice]
      #flash-good{ :style => "display: block" }
        = flash[:notice]
        .note
          = "(esc key hides this message)"[]
    - elsif flash[:warning] || flash[:error]
      #flash-bad{ :style => "display: block" }
        = (flash[:warning] || '') + (flash[:error] || '')
        .note
          = "(esc key hides this message)"[]
    - if flash[:notice] || flash[:warning] || flash[:error]
      :javascript
        var trigger = $("a#show-flash").overlay({
          top: 165,
          mask: {
            color: '#000000',
            loadSpeed: 500,
            opacity: 0.5
          },
          closeOnClick: true
        });
        overlay = trigger.overlay();
        overlay.load();
        window.setTimeout(function() {overlay.close();}, 2000)
    - if $ENABLE_ANALYTICS || true
      :javascript
        var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
        document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
      :javascript
        try { var pageTracker = _gat._getTracker("#{$GOOGLE_ANALYTICS_ID}"); pageTracker._trackPageview(); } catch(err) {}
